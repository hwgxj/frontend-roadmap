# Next.js 后端管理完全指南

## 📚 目录
1. [API 文件结构](#api-文件结构)
2. [创建 API](#创建-api)
3. [处理不同请求](#处理不同请求)
4. [数据管理](#数据管理)
5. [调试技巧](#调试技巧)
6. [最佳实践](#最佳实践)

---

## 📁 API 文件结构

### 基本规则

```
src/app/api/
└── [功能模块]/
    └── route.ts

文件夹名 = URL 路径
route.ts = 必须是这个名字
```

### 推荐结构（针对你的项目）

```
src/app/api/
├── roadmap/              # 路线图相关
│   ├── route.ts         # GET /api/roadmap - 获取数据
│   ├── save/
│   │   └── route.ts     # POST /api/roadmap/save - 保存数据
│   └── reset/
│       └── route.ts     # POST /api/roadmap/reset - 重置数据
│
├── notes/               # 笔记相关
│   └── route.ts         # GET/POST /api/notes
│
├── stats/               # 统计相关
│   └── route.ts         # POST /api/stats - 计算统计
│
└── health/              # 健康检查
    └── route.ts         # GET /api/health - 检查服务状态
```

---

## 🚀 创建 API

### 模板1：简单的 GET API

```typescript
// src/app/api/health/route.ts

import { NextResponse } from 'next/server';

export async function GET() {
  return NextResponse.json({
    status: 'ok',
    timestamp: new Date().toISOString(),
    message: '服务器运行正常'
  });
}
```

### 模板2：接收数据的 POST API

```typescript
// src/app/api/roadmap/save/route.ts

import { NextResponse } from 'next/server';

export async function POST(request: Request) {
  try {
    // 1. 获取请求体数据
    const body = await request.json();
    
    // 2. 验证数据
    if (!body.data) {
      return NextResponse.json(
        { error: '缺少数据' },
        { status: 400 }
      );
    }
    
    // 3. 处理数据（这里可以保存到数据库）
    console.log('保存数据：', body.data);
    
    // 4. 返回结果
    return NextResponse.json({
      success: true,
      message: '保存成功',
      savedAt: new Date().toISOString()
    });
    
  } catch (error) {
    console.error('保存失败：', error);
    return NextResponse.json(
      { error: '服务器错误' },
      { status: 500 }
    );
  }
}
```

### 模板3：CRUD 完整示例

```typescript
// src/app/api/notes/route.ts

import { NextResponse } from 'next/server';

// 临时数据存储（实际项目会用数据库）
let notesStore: Record<string, string> = {};

// GET - 获取所有笔记
export async function GET() {
  return NextResponse.json({
    success: true,
    data: notesStore
  });
}

// POST - 创建笔记
export async function POST(request: Request) {
  try {
    const { itemId, content } = await request.json();
    
    if (!itemId || !content) {
      return NextResponse.json(
        { error: 'itemId 和 content 不能为空' },
        { status: 400 }
      );
    }
    
    notesStore[itemId] = content;
    
    return NextResponse.json({
      success: true,
      message: '笔记创建成功'
    });
    
  } catch (error) {
    return NextResponse.json(
      { error: '创建失败' },
      { status: 500 }
    );
  }
}

// DELETE - 删除所有笔记
export async function DELETE() {
  notesStore = {};
  return NextResponse.json({
    success: true,
    message: '已清空所有笔记'
  });
}
```

### 模板4：带参数的动态路由

```typescript
// src/app/api/notes/[itemId]/route.ts

import { NextResponse } from 'next/server';

// GET /api/notes/html-1
export async function GET(
  request: Request,
  { params }: { params: { itemId: string } }
) {
  const itemId = params.itemId;
  
  // 从数据库获取特定笔记
  const note = await getNote(itemId);
  
  if (!note) {
    return NextResponse.json(
      { error: '笔记不存在' },
      { status: 404 }
    );
  }
  
  return NextResponse.json({
    success: true,
    data: note
  });
}

// PUT /api/notes/html-1
export async function PUT(
  request: Request,
  { params }: { params: { itemId: string } }
) {
  const itemId = params.itemId;
  const { content } = await request.json();
  
  // 更新笔记
  await updateNote(itemId, content);
  
  return NextResponse.json({
    success: true,
    message: '更新成功'
  });
}

// DELETE /api/notes/html-1
export async function DELETE(
  request: Request,
  { params }: { params: { itemId: string } }
) {
  const itemId = params.itemId;
  
  // 删除笔记
  await deleteNote(itemId);
  
  return NextResponse.json({
    success: true,
    message: '删除成功'
  });
}
```

---

## 🔄 处理不同请求

### HTTP 方法对照表

| HTTP 方法 | 用途 | 示例 |
|-----------|------|------|
| GET | 获取数据 | 获取路线图数据 |
| POST | 创建数据 | 保存新笔记 |
| PUT | 完整更新 | 更新整个用户信息 |
| PATCH | 部分更新 | 只更新用户名 |
| DELETE | 删除数据 | 删除笔记 |

### 在一个文件中处理多个方法

```typescript
// src/app/api/roadmap/route.ts

import { NextResponse } from 'next/server';

// GET - 获取路线图数据
export async function GET() {
  const data = await loadRoadmapData();
  return NextResponse.json({ success: true, data });
}

// POST - 创建新路线图
export async function POST(request: Request) {
  const newData = await request.json();
  await createRoadmap(newData);
  return NextResponse.json({ success: true, message: '创建成功' });
}

// PUT - 更新整个路线图
export async function PUT(request: Request) {
  const updatedData = await request.json();
  await updateRoadmap(updatedData);
  return NextResponse.json({ success: true, message: '更新成功' });
}

// DELETE - 删除路线图
export async function DELETE() {
  await deleteRoadmap();
  return NextResponse.json({ success: true, message: '删除成功' });
}
```

---

## 💾 数据管理

### 方式1：内存存储（最简单，重启丢失）

```typescript
// src/app/api/store.ts

// 全局变量存储数据
export let roadmapData: any = null;
export let notesData: Record<string, string> = {};

// API 中使用
import { roadmapData } from '../store';

export async function GET() {
  return Response.json({ data: roadmapData });
}
```

**优点**：简单  
**缺点**：重启后数据丢失

---

### 方式2：文件存储（简单，数据持久化）

```typescript
// src/app/api/roadmap/save/route.ts

import fs from 'fs';
import path from 'path';

export async function POST(request: Request) {
  const data = await request.json();
  
  // 保存到文件
  const filePath = path.join(process.cwd(), 'data', 'roadmap.json');
  
  // 确保目录存在
  const dir = path.dirname(filePath);
  if (!fs.existsSync(dir)) {
    fs.mkdirSync(dir, { recursive: true });
  }
  
  // 写入文件
  fs.writeFileSync(filePath, JSON.stringify(data, null, 2));
  
  return Response.json({ success: true, message: '保存成功' });
}

// 读取文件
export async function GET() {
  const filePath = path.join(process.cwd(), 'data', 'roadmap.json');
  
  if (!fs.existsSync(filePath)) {
    return Response.json({ data: null });
  }
  
  const content = fs.readFileSync(filePath, 'utf-8');
  const data = JSON.parse(content);
  
  return Response.json({ success: true, data });
}
```

**优点**：数据持久化，不需要数据库  
**缺点**：不适合多用户场景

---

### 方式3：数据库存储（完整方案）

```typescript
// src/app/api/roadmap/route.ts

import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

export async function GET(request: Request) {
  // 从数据库读取
  const roadmaps = await prisma.roadmap.findMany();
  return Response.json({ success: true, data: roadmaps });
}

export async function POST(request: Request) {
  const data = await request.json();
  
  // 保存到数据库
  const roadmap = await prisma.roadmap.create({
    data: {
      userId: data.userId,
      content: JSON.stringify(data.content),
    }
  });
  
  return Response.json({ success: true, data: roadmap });
}
```

**优点**：适合多用户，数据安全  
**缺点**：需要配置数据库

---

## 🐛 调试技巧

### 1. 使用 console.log

```typescript
export async function POST(request: Request) {
  console.log('🎯 API 被调用');
  
  const body = await request.json();
  console.log('📦 收到的数据：', body);
  
  // 处理数据
  const result = processData(body);
  console.log('✅ 处理结果：', result);
  
  return Response.json({ success: true });
}
```

**查看日志**：在运行 `npm run dev` 的终端查看

---

### 2. 返回详细错误信息

```typescript
export async function POST(request: Request) {
  try {
    const body = await request.json();
    
    // 验证数据
    if (!body.itemId) {
      return Response.json(
        { 
          error: '缺少 itemId',
          received: body,
          hint: '请确保发送了 itemId 字段'
        },
        { status: 400 }
      );
    }
    
    // 处理逻辑...
    
  } catch (error) {
    console.error('❌ 错误详情：', error);
    return Response.json(
      { 
        error: '服务器错误',
        message: error instanceof Error ? error.message : '未知错误',
        stack: process.env.NODE_ENV === 'development' ? error.stack : undefined
      },
      { status: 500 }
    );
  }
}
```

---

### 3. 查看请求信息

```typescript
export async function POST(request: Request) {
  // 打印请求信息
  console.log('Method:', request.method);
  console.log('URL:', request.url);
  console.log('Headers:', Object.fromEntries(request.headers));
  
  const body = await request.json();
  console.log('Body:', body);
  
  return Response.json({ success: true });
}
```

---

### 4. 使用浏览器开发者工具

1. 打开浏览器（F12）
2. 切换到 "Network" 标签
3. 触发 API 调用
4. 点击请求查看：
   - Request Headers
   - Request Payload
   - Response
   - Status Code

---

### 5. 使用 API 测试工具

#### 方法1：创建测试文件（推荐）

```http
### 测试 GET 请求
GET http://localhost:3000/api/roadmap

### 测试 POST 请求
POST http://localhost:3000/api/roadmap/save
Content-Type: application/json

{
  "data": {
    "itemId": "html-1",
    "status": "completed"
  }
}

### 测试带参数的请求
GET http://localhost:3000/api/notes/html-1
```

安装 VSCode 插件：**REST Client**

#### 方法2：使用 curl

```bash
# GET 请求
curl http://localhost:3000/api/roadmap

# POST 请求
curl -X POST http://localhost:3000/api/roadmap/save \
  -H "Content-Type: application/json" \
  -d '{"data":{"itemId":"html-1","status":"completed"}}'
```

---

## 🎯 最佳实践

### 1. 统一的响应格式

```typescript
// src/lib/api-response.ts

export function successResponse(data: any, message = '成功') {
  return Response.json({
    success: true,
    message,
    data,
    timestamp: new Date().toISOString()
  });
}

export function errorResponse(error: string, status = 400) {
  return Response.json(
    {
      success: false,
      error,
      timestamp: new Date().toISOString()
    },
    { status }
  );
}

// 使用
import { successResponse, errorResponse } from '@/lib/api-response';

export async function GET() {
  const data = await fetchData();
  return successResponse(data);
}
```

---

### 2. 错误处理包装器

```typescript
// src/lib/api-handler.ts

export function apiHandler(handler: Function) {
  return async (request: Request, context?: any) => {
    try {
      return await handler(request, context);
    } catch (error) {
      console.error('API Error:', error);
      return Response.json(
        { 
          error: '服务器错误',
          message: error instanceof Error ? error.message : '未知错误'
        },
        { status: 500 }
      );
    }
  };
}

// 使用
export const POST = apiHandler(async (request: Request) => {
  const data = await request.json();
  // 处理逻辑...
  return Response.json({ success: true });
});
```

---

### 3. 数据验证

```typescript
// src/lib/validation.ts

export function validateRequired(data: any, fields: string[]) {
  const missing = fields.filter(field => !data[field]);
  if (missing.length > 0) {
    throw new Error(`缺少必填字段: ${missing.join(', ')}`);
  }
}

export function validateEmail(email: string) {
  const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!regex.test(email)) {
    throw new Error('邮箱格式不正确');
  }
}

// 使用
import { validateRequired } from '@/lib/validation';

export async function POST(request: Request) {
  const body = await request.json();
  
  try {
    validateRequired(body, ['itemId', 'status']);
    // 继续处理...
  } catch (error) {
    return Response.json(
      { error: error.message },
      { status: 400 }
    );
  }
}
```

---

### 4. 环境变量管理

```bash
# .env.local

# 数据库
DATABASE_URL="your-database-url"

# API 密钥
API_SECRET="your-secret-key"

# 环境
NODE_ENV="development"
```

```typescript
// 在 API 中使用
export async function GET() {
  const dbUrl = process.env.DATABASE_URL;
  const secret = process.env.API_SECRET;
  
  // 使用环境变量...
}
```

---

### 5. 日志管理

```typescript
// src/lib/logger.ts

export const logger = {
  info: (message: string, data?: any) => {
    console.log(`ℹ️ [INFO] ${message}`, data || '');
  },
  
  error: (message: string, error?: any) => {
    console.error(`❌ [ERROR] ${message}`, error || '');
  },
  
  warn: (message: string, data?: any) => {
    console.warn(`⚠️ [WARN] ${message}`, data || '');
  },
  
  debug: (message: string, data?: any) => {
    if (process.env.NODE_ENV === 'development') {
      console.log(`🐛 [DEBUG] ${message}`, data || '');
    }
  }
};

// 使用
import { logger } from '@/lib/logger';

export async function POST(request: Request) {
  logger.info('收到保存请求');
  
  try {
    const data = await request.json();
    logger.debug('请求数据', data);
    
    // 处理逻辑...
    
    logger.info('保存成功');
    return Response.json({ success: true });
    
  } catch (error) {
    logger.error('保存失败', error);
    return Response.json({ error: '保存失败' }, { status: 500 });
  }
}
```

---

## 📋 检查清单

### 创建新 API 时：

- [ ] 在 `src/app/api/` 下创建文件夹
- [ ] 创建 `route.ts` 文件
- [ ] 导出对应的 HTTP 方法函数
- [ ] 添加错误处理
- [ ] 添加数据验证
- [ ] 添加日志
- [ ] 测试 API
- [ ] 在前端调用测试

### 代码质量检查：

- [ ] 使用统一的响应格式
- [ ] 有完善的错误处理
- [ ] 有数据验证
- [ ] 有清晰的日志
- [ ] 有注释说明
- [ ] HTTP 状态码正确
- [ ] 类型定义完整（TypeScript）

---

## 🚀 实战示例

### 完整的保存路线图 API

```typescript
// src/app/api/roadmap/save/route.ts

import { NextResponse } from 'next/server';
import fs from 'fs';
import path from 'path';

// 日志工具
const log = (message: string, data?: any) => {
  console.log(`[Roadmap API] ${message}`, data || '');
};

// 数据验证
function validateRoadmapData(data: any) {
  if (!data) {
    throw new Error('数据不能为空');
  }
  
  if (!Array.isArray(data)) {
    throw new Error('数据格式错误，应该是数组');
  }
  
  return true;
}

// 保存到文件
function saveToFile(data: any) {
  const dataDir = path.join(process.cwd(), 'data');
  const filePath = path.join(dataDir, 'roadmap.json');
  
  // 确保目录存在
  if (!fs.existsSync(dataDir)) {
    fs.mkdirSync(dataDir, { recursive: true });
  }
  
  // 写入文件
  fs.writeFileSync(filePath, JSON.stringify(data, null, 2), 'utf-8');
  
  return filePath;
}

// POST 请求处理
export async function POST(request: Request) {
  const startTime = Date.now();
  
  try {
    log('收到保存请求');
    
    // 1. 获取数据
    const body = await request.json();
    log('请求数据大小', `${JSON.stringify(body).length} bytes`);
    
    // 2. 验证数据
    validateRoadmapData(body.data);
    log('数据验证通过');
    
    // 3. 保存数据
    const filePath = saveToFile(body.data);
    log('数据已保存到', filePath);
    
    // 4. 返回成功
    const duration = Date.now() - startTime;
    log('保存完成', `耗时 ${duration}ms`);
    
    return NextResponse.json({
      success: true,
      message: '保存成功',
      savedAt: new Date().toISOString(),
      duration: `${duration}ms`
    });
    
  } catch (error) {
    const duration = Date.now() - startTime;
    log('保存失败', error);
    
    return NextResponse.json(
      {
        success: false,
        error: error instanceof Error ? error.message : '保存失败',
        duration: `${duration}ms`
      },
      { status: 500 }
    );
  }
}

// GET 请求处理
export async function GET() {
  try {
    log('收到读取请求');
    
    const filePath = path.join(process.cwd(), 'data', 'roadmap.json');
    
    if (!fs.existsSync(filePath)) {
      log('文件不存在');
      return NextResponse.json({
        success: true,
        data: null,
        message: '暂无数据'
      });
    }
    
    const content = fs.readFileSync(filePath, 'utf-8');
    const data = JSON.parse(content);
    
    log('读取成功', `${content.length} bytes`);
    
    return NextResponse.json({
      success: true,
      data,
      loadedAt: new Date().toISOString()
    });
    
  } catch (error) {
    log('读取失败', error);
    
    return NextResponse.json(
      {
        success: false,
        error: '读取失败'
      },
      { status: 500 }
    );
  }
}
```

---

## 🎊 总结

### 管理后端的核心步骤：

1. **组织文件**：按功能模块划分 API
2. **处理请求**：使用正确的 HTTP 方法
3. **管理数据**：选择合适的存储方式
4. **调试测试**：使用日志和工具
5. **最佳实践**：统一格式，错误处理

### 推荐流程：

```
需求分析
  ↓
设计 API 结构
  ↓
创建 route.ts 文件
  ↓
实现业务逻辑
  ↓
添加错误处理
  ↓
测试 API
  ↓
在前端调用
  ↓
部署上线
```

---

**下一步**：选择一个功能，按照这个指南创建你的第一个完整 API！



